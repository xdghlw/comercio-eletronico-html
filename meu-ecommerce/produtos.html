<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos</title>
    <!-- <link rel="stylesheet" href="/meu-ecommerce/css/style.css"> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>


<body>
    <header>
        <!-- Uma Bootstrap Navbar personalizada será renderizada via Javascript-->
    </header>
    <main class="container my-4">
        <div class="toast-container position-fixed p-3" style="bottom:25px; left: 40%;">
            <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">

                    <div class="toast-body p-3 text-center">

                    </div>
                    <button type="button" class="btn-close btn-close-white me-3 m-auto" data-bs-dismiss="toast"
                        aria-label="Close"></button>
                </div>
            </div>
        </div>
        <div id="lista-produtos" class="mt-5"></div>
    </main>
    <footer></footer>
    <script>
        // O acesso a API para obter os produtos a serem renderizados deve ser feito apenas se não estiverem persistentes no localStorage.
        if (!localStorage.hasOwnProperty("produtos")) {
            fetch("https://ppw-1-tads.vercel.app/api/products")
                .then(res => {
                    if (!res.ok) throw new Error("Erro na requisição");
                    return res.json();
                })
                .then(data => {
                    // console.log(data.products)
                    produtos = JSON.parse(localStorage.getItem("produtos"));
                    const objetoProdutos = {};
                    const persistenciaProdutos = {};

                    data.products.forEach(({ id, ...resto }) => {
                        persistenciaProdutos[id] = resto;
                    });
                    localStorage.setItem("produtos", JSON.stringify(persistenciaProdutos));
                    renderizarProdutos();
                });
        } else {
            renderizarProdutos();
        }


        function renderizarProdutos() {
            const main = document.querySelector("main");
            const container = document.getElementById("lista-produtos");
            container.innerHTML = "";
            let row;
            var produtos = JSON.parse(localStorage.getItem("produtos"));

            Object.keys(produtos).forEach((idProduto, index) => {
                produto = produtos[idProduto]
                // cria uma nova row a cada 4 cards
                if (index % 4 === 0) {
                    row = document.createElement("div");
                    row.className = "row row-cols-1 row-cols-xxl-4 row-cols-md-2 g-5 mb-4";
                    main.appendChild(row);
                    // console.log(index);
                }

                const col = document.createElement("div");
                col.className = "col";

                col.innerHTML = `
                <div id="${idProduto}" class="card h-100">
                <img src="${produto.image}" class="card-img-top p-2" alt="${produto.name}">
                <div class="card-body d-flex flex-column border-top">
                    <h5 class="card-title text-center">${produto.name}</h5>
                    <p class="card-text text-center">${produto.description}</p>
                    <p class="card-text text-center text-body-secondary">R$ ${produto.price.toFixed(2)}</p>
                    <button id="liveToastBtn" class="btn btn-primary mt-auto add-cart" data-id=${idProduto}>
                    Adicionar ao Carrinho
                    </button>
                </div>
                </div>
                `;
                row.appendChild(col);
            });
        }

        //Registro de espera de evento para todos os botões existentes no elemento main.
        document.querySelector("main").addEventListener("click", function (event) {
            const botao = event.target.closest("button[data-id]");
            if (!botao) return;
            const idProduto = botao.dataset.id;
            adicionarCarrinho(idProduto);
        });


        function exibirToastConfirmacao() {
            const toastLiveExample = document.getElementById("liveToast");
            toastLiveExample.classList.add("text-bg-success");
            document.getElementsByClassName("toast-body")[0].innerHTML = `
                <span style="fontsize: 100px"><i class="bi bi-check-square mx-2"></i></span>
                O produto foi adicionado ao carrinho.
                
            `;
            const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample);
            toastBootstrap.show();
        }


        function adicionarCarrinho(idProduto) {
            let carrinhoDeCompras = {};
            // let produto;
            try {
                if (localStorage.hasOwnProperty("carrinho") && localStorage.getItem("carrinho").length !== 0) {
                    carrinhoDeCompras = JSON.parse(localStorage.getItem("carrinho"));
                    if (JSON.parse(localStorage.getItem("carrinho")).hasOwnProperty(idProduto)) {
                        carrinhoDeCompras[idProduto].quantidade += 1;
                        localStorage.setItem("carrinho", JSON.stringify(carrinhoDeCompras));
                        exibirToastConfirmacao();
                        atualizarBadge();
                        console.log(carrinhoDeCompras);
                        return;
                    }
                }
                localStorage.removeItem("carrinho");
                carrinhoDeCompras[idProduto] = {
                    ...JSON.parse(localStorage.getItem("produtos"))[idProduto],
                    quantidade: 1
                };
                localStorage.setItem("carrinho", JSON.stringify(carrinhoDeCompras));
                exibirToastConfirmacao();
                atualizarBadge();
                console.log(carrinhoDeCompras);
            } catch (SyntaxError) {
                console.log(SyntaxError);
            }
        }
    </script>
    <script src="js/renderizar-navbar.js"></script>
</body>

</html>